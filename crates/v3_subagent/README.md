# v3_subagent - Mini Claude Code: Subagent Mechanism

åŸºäº Python ç‰ˆæœ¬ `v3_subagent.py` çš„ Rust å®ç°ï¼Œæ·»åŠ äº†å­ä»£ç†ï¼ˆsubagentï¼‰æœºåˆ¶æ¥è§£å†³ä¸Šä¸‹æ–‡æ±¡æŸ“é—®é¢˜ã€‚

## æ ¸å¿ƒç†å¿µ

**"åˆ†è€Œæ²»ä¹‹ï¼Œä¸Šä¸‹æ–‡éš”ç¦»"**

v2 ç‰ˆæœ¬æ·»åŠ äº†è§„åˆ’åŠŸèƒ½ï¼Œä½†å¯¹äºå¤§å‹ä»»åŠ¡ï¼ˆå¦‚"æ¢ç´¢ä»£ç åº“ç„¶åé‡æ„è®¤è¯"ï¼‰ï¼Œå•ä¸ªä»£ç†ä¼šé‡åˆ°é—®é¢˜ï¼š

### é—®é¢˜ - ä¸Šä¸‹æ–‡æ±¡æŸ“

```
å•ä»£ç†å†å²è®°å½•ï¼š
  [æ¢ç´¢ä¸­...] cat file1.rs -> 500 è¡Œ
  [æ¢ç´¢ä¸­...] cat file2.rs -> 300 è¡Œ
  ... 15 ä¸ªæ–‡ä»¶ ...
  [ç°åœ¨é‡æ„...] "ç­‰ç­‰ï¼Œfile1 åŒ…å«ä»€ä¹ˆï¼Ÿ"
```

æ¨¡å‹çš„ä¸Šä¸‹æ–‡è¢«æ¢ç´¢ç»†èŠ‚å¡«æ»¡ï¼Œç•™ç»™å®é™…ä»»åŠ¡çš„ç©ºé—´å¾ˆå°‘ã€‚

### è§£å†³æ–¹æ¡ˆ - å­ä»£ç†ä¸éš”ç¦»ä¸Šä¸‹æ–‡

```
ä¸»ä»£ç†å†å²è®°å½•ï¼š
  [Task: æ¢ç´¢ä»£ç åº“]
    -> å­ä»£ç†åœ¨è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­æ¢ç´¢ 20 ä¸ªæ–‡ä»¶
    -> ä»…è¿”å›ï¼š"Auth åœ¨ src/auth/ï¼ŒDB åœ¨ src/models/"
  [ç°åœ¨ç”¨å¹²å‡€çš„ä¸Šä¸‹æ–‡é‡æ„]
```

æ¯ä¸ªå­ä»£ç†å…·æœ‰ï¼š
1. è‡ªå·±çš„å…¨æ–°æ¶ˆæ¯å†å²
2. è¿‡æ»¤çš„å·¥å…·ï¼ˆexplore ä¸èƒ½å†™å…¥ï¼‰
3. ä¸“é—¨çš„ç³»ç»Ÿæç¤º
4. ä»…å‘çˆ¶ä»£ç†è¿”å›æœ€ç»ˆæ‘˜è¦

## åŠŸèƒ½ç‰¹æ€§

### ä» v2 ç»§æ‰¿çš„æ‰€æœ‰åŠŸèƒ½

- âœ… **TodoManager** - ç»“æ„åŒ–ä»»åŠ¡åˆ—è¡¨ç®¡ç†
- âœ… **æ‰€æœ‰åŸºç¡€å·¥å…·** - bash, read_file, write_file, edit_file
- âœ… **å®‰å…¨è·¯å¾„éªŒè¯** - é˜²æ­¢ç›®å½•éå†æ”»å‡»
- âœ… **æ€è€ƒåŠ¨ç”»** - ç¾è§‚çš„åŠ è½½æŒ‡ç¤ºå™¨
- âœ… **é”™è¯¯å¤„ç†** - å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

### v3 æ–°å¢åŠŸèƒ½

- ğŸ†• **Task å·¥å…·** - ç”Ÿæˆå…·æœ‰éš”ç¦»ä¸Šä¸‹æ–‡çš„å­ä»£ç†
- ğŸ†• **Agent ç±»å‹æ³¨å†Œè¡¨** - explore, code, plan
- ğŸ†• **å·¥å…·è¿‡æ»¤** - æ ¹æ®ä»£ç†ç±»å‹é™åˆ¶å¯ç”¨å·¥å…·
- ğŸ†• **è¿›åº¦æ˜¾ç¤º** - å®æ—¶å­ä»£ç†è¿›åº¦è¿½è¸ª

## ä»£ç†ç±»å‹

| ç±»å‹    | å·¥å…·                | ç”¨é€”                    |
|---------|---------------------|------------------------|
| explore | bash, read_file     | åªè¯»æ¢ç´¢å’Œåˆ†æ          |
| code    | æ‰€æœ‰å·¥å…·            | å®Œæ•´çš„å®ç°å’Œä¿®æ”¹        |
| plan    | bash, read_file     | è®¾è®¡è§„åˆ’ï¼Œä¸ä¿®æ”¹        |

## ä½¿ç”¨æ–¹æ³•

### ç¼–è¯‘å’Œè¿è¡Œ

```bash
# ç¼–è¯‘
cargo build -p v3_subagent

# è¿è¡Œï¼ˆé»˜è®¤å¯ç”¨ readline æ”¯æŒï¼Œæä¾›å‘½ä»¤å†å²ï¼‰
cargo run -p v3_subagent

# ä¸ä½¿ç”¨ readlineï¼ˆå¦‚æœé‡åˆ°å…¼å®¹æ€§é—®é¢˜ï¼‰
cargo run -p v3_subagent --no-default-features
```

### ç¤ºä¾‹å¯¹è¯

```
You: é‡æ„ auth æ¨¡å—ä»¥ä½¿ç”¨ JWT

Agent:
  > TodoWrite
  [ ] æ¢ç´¢ auth ç›¸å…³æ–‡ä»¶
  [>] è®¾è®¡ JWT è¿ç§»ç­–ç•¥ <- è®¾è®¡ä¸­...
  [ ] å®ç° JWT ä»¤ç‰Œ

  > Task
  [explore] æŸ¥æ‰¾æ‰€æœ‰ auth ç›¸å…³æ–‡ä»¶ ... 5 tools, 3.2s
  ç»“æœï¼šè®¤è¯ä»£ç åœ¨ src/auth/login.rsï¼Œä½¿ç”¨ä¼šè¯...

  > Task
  [plan] è®¾è®¡ JWT è¿ç§» ... 3 tools, 1.8s
  è®¡åˆ’ï¼š
  1. æ·»åŠ  jwt ä¾èµ–
  2. åˆ›å»º jwt_utils.rs
  3. æ›´æ–° login.rs ä½¿ç”¨ JWT

  > Task
  [code] å®ç° JWT ä»¤ç‰Œ ... 8 tools, 5.4s
  å·²åˆ›å»º jwt_utils.rsï¼Œå·²æ›´æ–° login.rs

å®Œæˆï¼å·²å°†è®¤è¯è¿ç§»åˆ° JWTã€‚
```

## å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸Šä¸‹æ–‡éš”ç¦»

å­ä»£ç†åœ¨è‡ªå·±çš„æ¶ˆæ¯å†å²ä¸­è¿è¡Œï¼Œä¸ä¼šçœ‹åˆ°çˆ¶ä»£ç†çš„ä¸Šä¸‹æ–‡ã€‚è¿™ä¿æŒä¸»å¯¹è¯å¹²å‡€ã€‚

```rust
// å­ä»£ç†è·å¾—å…¨æ–°çš„å†å²è®°å½•
let mut sub_messages = vec![Message {
    role: Role::User,
    content: vec![ContentBlock::text(prompt)],
}];
```

### 2. å·¥å…·è¿‡æ»¤

æ¯ç§ä»£ç†ç±»å‹éƒ½æœ‰å…è®¸çš„å·¥å…·ç™½åå•ã€‚è¿™é˜²æ­¢äº†æ„å¤–ä¿®æ”¹ã€‚

```rust
fn get_tools_for_agent(agent_type: &str) -> Vec<Tool> {
    let config = agent_types.get(agent_type)?;

    if config.tools.contains(&"*") {
        return base_tools;  // æ‰€æœ‰å·¥å…·
    }

    // ä»…è¿‡æ»¤å…è®¸çš„å·¥å…·
    base_tools.filter(|t| config.tools.contains(&t.name))
}
```

### 3. ä»…è¿”å›æ‘˜è¦

å­ä»£ç†å°†æ‰€æœ‰è¯¦ç»†ä¿¡æ¯ä¿ç•™åœ¨è‡ªå·±çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œä»…è¿”å›ç®€æ´çš„æ‘˜è¦ã€‚

```rust
// æå–å¹¶ä»…è¿”å›æœ€ç»ˆæ–‡æœ¬
for block in response.content {
    if let ContentBlock::Text { text } = block {
        return text;  // çˆ¶ä»£ç†ä»…çœ‹åˆ°è¿™ä¸ª
    }
}
```

## å¯¹æ¯” Python ç‰ˆæœ¬

| ç‰¹æ€§ | Python | Rust |
|------|--------|------|
| ç±»å‹å®‰å…¨ | âŒ | âœ… |
| æ€§èƒ½ | ä¸­ç­‰ | ä¼˜ç§€ |
| å¼‚æ­¥æ”¯æŒ | âœ… (asyncio) | âœ… (tokio) |
| å†…å­˜å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æ—¶ä¿è¯ |
| å¹¶å‘ | GIL é™åˆ¶ | çœŸæ­£çš„å¹¶å‘ |
| ä¾èµ–ç®¡ç† | pip | Cargo |

## æŠ€æœ¯å®ç°

### Agent ç±»å‹æ³¨å†Œè¡¨

```rust
fn get_agent_types() -> HashMap<String, AgentConfig> {
    let mut types = HashMap::new();

    types.insert("explore", AgentConfig {
        description: "åªè¯»ä»£ç†ç”¨äºæ¢ç´¢ä»£ç ",
        tools: vec!["bash", "read_file"],
        prompt: "ä½ æ˜¯æ¢ç´¢ä»£ç†ã€‚æœç´¢å’Œåˆ†æï¼Œä½†ä¸ä¿®æ”¹æ–‡ä»¶ã€‚",
    });

    // ... å…¶ä»–ç±»å‹
}
```

### å­ä»£ç†æ‰§è¡Œ

```rust
async fn run_task(
    client: &Client,
    config: &Config,
    description: &str,
    prompt: &str,
    agent_type: &str,
) -> String {
    // 1. ä¸“é—¨çš„ç³»ç»Ÿæç¤º
    let sub_system = format!("ä½ æ˜¯ {} å­ä»£ç†...", agent_type);

    // 2. è¿‡æ»¤çš„å·¥å…·
    let sub_tools = get_tools_for_agent(agent_type);

    // 3. éš”ç¦»çš„æ¶ˆæ¯å†å²
    let mut sub_messages = vec![Message::user(prompt)];

    // 4. è¿è¡Œä»£ç†å¾ªç¯
    loop {
        let response = client.messages(request).await?;
        // ... å¤„ç†å·¥å…·è°ƒç”¨ ...
    }

    // 5. ä»…è¿”å›æœ€ç»ˆæ–‡æœ¬
    extract_final_text(response)
}
```

## ç¯å¢ƒé…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
ANTHROPIC_API_KEY=your-api-key-here
MODEL_NAME=claude-sonnet-4-20250514  # å¯é€‰
ANTHROPIC_BASE_URL=https://api.anthropic.com  # å¯é€‰
```

## æ¶æ„ä¼˜åŠ¿

### 1. å¯æ‰©å±•æ€§
è½»æ¾æ·»åŠ æ–°çš„ä»£ç†ç±»å‹å’Œå·¥å…·

### 2. å¯ç»´æŠ¤æ€§
æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»

### 3. å¯æµ‹è¯•æ€§
æ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•

### 4. å®‰å…¨æ€§
- å·¥å…·è¿‡æ»¤é˜²æ­¢æ„å¤–æ“ä½œ
- è·¯å¾„éªŒè¯é˜²æ­¢ç›®å½•éå†
- å±é™©å‘½ä»¤é˜»æ­¢

## æ€§èƒ½ä¼˜åŒ–

- **å¼‚æ­¥ I/O** - ä½¿ç”¨ Tokio è¿›è¡Œé«˜æ•ˆå¹¶å‘
- **ä¸Šä¸‹æ–‡ç®¡ç†** - å­ä»£ç†ä¿æŒä¸»ä¸Šä¸‹æ–‡æ¸…æ´
- **å·¥å…·è¿‡æ»¤** - å‡å°‘ä¸å¿…è¦çš„å·¥å…·å¯ç”¨æ€§
- **è¿›åº¦è¿½è¸ª** - å®æ—¶åé¦ˆè€Œä¸é˜»å¡

## è®¸å¯è¯

MIT License

## ç›¸å…³é¡¹ç›®

- [v0_bash_agent](../v0_bash_agent/) - åŸºç¡€ bash ä»£ç†
- [v1_basic_agent](../v1_basic_agent/) - å¸¦æ–‡ä»¶æ“ä½œçš„åŸºç¡€ä»£ç†
- [v2_todo_agent](../v2_todo_agent/) - å¸¦ TodoManager çš„è§„åˆ’ä»£ç†
- [anthropic-rs](https://github.com/andyli386/anthropic-rs) - Anthropic API çš„ Rust SDK
